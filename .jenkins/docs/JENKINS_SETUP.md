# ğŸš€ Jenkins CI/CD Setup with PCOV Coverage

## ğŸ“‹ **Overview**

Dokumentasi ini menjelaskan cara setup Jenkins untuk run automated tests dengan PCOV code coverage yang akan diintegrasikan dengan SonarQube.

---

## ğŸ³ **Option 1: Jenkins dengan Docker Agent (RECOMMENDED)**

### **1. Docker Setup**

Jenkins agent dengan PHP 8.4 + PCOV sudah dikonfigurasi di `.jenkins/Dockerfile`.

**Build Docker Image:**

```bash
cd .jenkins
docker build -t nusahire-jenkins-agent:latest .
```

**Verify PCOV installed:**

```bash
docker run --rm nusahire-jenkins-agent:latest php -m | grep pcov
# Output: pcov
```

### **2. Jenkins Pipeline Configuration**

Update Jenkins job untuk pakai Docker agent:

```groovy
pipeline {
    agent {
        docker {
            image 'nusahire-jenkins-agent:latest'
            args '-v $HOME/.composer:/root/.composer'
        }
    }
    // ... rest of pipeline
}
```

### **3. Environment Variables di Jenkins**

Set di Jenkins credentials/environment:

```
PROJECT_KEY_SONAR_NUSAHIRE=nusanet_nusahire_AZhZb275_KIUeGBBlVuR
AUTHORIZATION_SONAR_NUSAWORK=<your-token>
```

---

## ğŸ–¥ï¸ **Option 2: Jenkins Bare Metal Server**

Jika Jenkins agent running di server langsung (bukan Docker):

### **1. Install PCOV di Jenkins Server**

**Ubuntu/Debian:**

```bash
# Install PHP 8.4 (jika belum)
sudo apt-get update
sudo apt-get install -y php8.4-cli php8.4-xml php8.4-mbstring

# Install PCOV
sudo pecl install pcov
sudo echo "extension=pcov.so" > /etc/php/8.4/cli/conf.d/20-pcov.ini

# Verify
php -m | grep pcov
```

**CentOS/RHEL:**

```bash
# Install PHP 8.4
sudo yum install -y php84-cli php84-xml php84-mbstring

# Install PCOV
sudo pecl install pcov
sudo echo "extension=pcov.so" > /etc/php.d/20-pcov.ini

# Verify
php -m | grep pcov
```

### **2. Disable Xdebug (if installed)**

PCOV dan Xdebug tidak bisa aktif bersamaan. Disable Xdebug:

```bash
# Disable Xdebug di CLI
sudo sed -i.backup 's/^zend_extension=xdebug/;zend_extension=xdebug/' /etc/php/8.4/cli/php.ini

# Atau remove Xdebug config
sudo rm /etc/php/8.4/cli/conf.d/*xdebug.ini

# Verify Xdebug tidak aktif
php -m | grep xdebug
# (should return nothing)
```

---

## ğŸ“Š **Pipeline Stages**

Jenkinsfile sudah dikonfigurasi dengan stages:

### **1. Preparation**
- Checkout source code

### **2. Install Dependencies**
- `composer install`
- Copy `.env.example` â†’ `.env`
- Generate app key

### **3. Run Tests with PCOV Coverage**
- Run tests: `php -d pcov.enabled=1 -d pcov.directory=app artisan test --coverage-clover=coverage.xml`
- Generate `coverage.xml` untuk SonarQube
- Cleanup test databases

### **4. Run Sonar**
- SonarScanner analysis
- Upload coverage report ke SonarQube

### **5. Check Status SonarQube**
- Verify quality gate status
- Fail pipeline jika quality gate failed

---

## ğŸ¯ **Coverage Report Files**

| File | Purpose | Generated By |
|------|---------|--------------|
| `coverage.xml` | SonarQube coverage report | PCOV + PHPUnit |
| `coverage-report/` | HTML coverage report (local only) | PCOV + PHPUnit |
| `build/logs/junit.xml` | Test execution report | PHPUnit |

---

## âš™ï¸ **SonarQube Configuration**

File `sonar-project.properties` sudah dikonfigurasi:

```properties
# Coverage report path
sonar.php.coverage.reportPaths=coverage.xml

# Exclude dari coverage
sonar.coverage.exclusions=tests/**,bootstrap/**,config/**,database/**,public/**,resources/**,routes/**,storage/**
```

---

## ğŸ”§ **Troubleshooting**

### **1. PCOV Not Found**

```bash
# Check PCOV installed
php -m | grep pcov

# If not installed
pecl install pcov
```

### **2. Coverage Report Not Generated**

```bash
# Verify PCOV enabled
php -d pcov.enabled=1 -m | grep pcov

# Check coverage.xml created
ls -la coverage.xml
```

### **3. Xdebug Interference**

```bash
# Check if both active
php -m | grep -E "(pcov|xdebug)"

# Should only show:
# pcov

# If xdebug shows, disable it
sudo mv /etc/php/8.4/cli/conf.d/xdebug.ini /etc/php/8.4/cli/conf.d/xdebug.ini.disabled
```

### **4. Pipeline Failing on Tests**

```bash
# Run tests manually di Jenkins workspace
cd /var/jenkins_home/workspace/nusahire
php -d pcov.enabled=1 -d pcov.directory=app artisan test --coverage-clover=coverage.xml

# Check logs
tail -f storage/logs/laravel.log
```

### **5. SonarQube Not Showing Coverage**

Pastikan:
- âœ… `coverage.xml` exists di workspace root
- âœ… `sonar.php.coverage.reportPaths=coverage.xml` di sonar-project.properties
- âœ… SonarScanner running AFTER test stage
- âœ… Coverage file format valid (clover XML)

---

## ğŸ“ˆ **Expected Performance**

**Jenkins Pipeline Duration:**

| Stage | Duration |
|-------|----------|
| Preparation | ~10s |
| Install Dependencies | ~30-60s |
| Run Tests + Coverage | ~10 min |
| Run Sonar | ~30s |
| Check Status | ~10s |
| **Total** | **~12-13 min** |

---

## âœ… **Verification Steps**

### **1. Verify PCOV di Jenkins Agent:**

```bash
# SSH ke Jenkins agent atau exec ke Docker container
docker exec -it <jenkins-agent> bash

# Check PCOV
php -m | grep pcov
# Output: pcov

# Check Xdebug (should be empty)
php -m | grep xdebug
# Output: (nothing)
```

### **2. Test PCOV Coverage:**

```bash
# Di Jenkins workspace
php -d pcov.enabled=1 -d pcov.directory=app artisan test --coverage-clover=coverage.xml

# Verify coverage.xml created
ls -la coverage.xml
cat coverage.xml | head -20
```

### **3. Check SonarQube:**

1. Buka SonarQube dashboard
2. Pilih project **nusahire**
3. Tab **Coverage** harus show percentage
4. Tab **Code** harus show covered/uncovered lines

---

## ğŸš€ **Best Practices**

### **1. Caching Composer Dependencies**

Tambahkan di Jenkinsfile untuk speed up builds:

```groovy
stage ('Install Dependencies') {
    steps {
        script {
            // Cache composer dependencies
            sh '''
                export COMPOSER_CACHE_DIR=/tmp/composer-cache
                composer install --no-interaction --prefer-dist --optimize-autoloader
            '''
        }
    }
}
```

### **2. Parallel Testing (Optional)**

Jika install ParaTest di Jenkins:

```bash
# Run tests in parallel for faster execution
php artisan test --parallel --processes=4 --coverage-clover=coverage.xml
```

**Note**: Hanya efektif untuk unit tests, tidak untuk integration tests.

### **3. Test Reports Archive**

Tambahkan di Jenkinsfile:

```groovy
post {
    always {
        // Archive coverage report
        publishHTML([
            reportDir: 'coverage-report',
            reportFiles: 'index.html',
            reportName: 'Coverage Report'
        ])
        
        // Archive test results
        junit 'build/logs/junit.xml'
    }
}
```

---

## ğŸ“ **Checklist Setup**

- [ ] PCOV installed di Jenkins agent/server
- [ ] Xdebug disabled (jika ada)
- [ ] Jenkinsfile updated dengan test stage
- [ ] sonar-project.properties include coverage path
- [ ] Environment variables set di Jenkins
- [ ] Test pipeline manually
- [ ] Verify coverage di SonarQube
- [ ] Setup notifications (Slack/Email) untuk failed builds

---

## ğŸ‰ **Summary**

**PCOV di Jenkins memberikan:**
- âœ… **Fast coverage**: ~10 min (vs 27 min dengan Xdebug)
- âœ… **SonarQube integration**: Automatic coverage upload
- âœ… **Quality gate**: Automatic check untuk pass/fail
- âœ… **Docker ready**: Easy deployment dengan container

**Workflow:**
```
Code Push â†’ Jenkins Trigger â†’ Install Deps â†’ Run Tests (PCOV) â†’ 
SonarQube Scan â†’ Quality Gate Check â†’ Deploy (if passed)
```
